<div class="orders-page">
  <div class="container">
    <h1 class="page-title">Mis Ã“rdenes</h1>

    @if (loading()) {
      <div class="loading-state">Cargando tus pedidos...</div>
    } @else if (orders().length > 0) {
      <div class="orders-list">
        @for (order of orders(); track order.id) {
          <div class="order-card">
            <div class="order-header">
              <div class="order-meta">
                <span class="order-number">Orden #{{ order.orderNumber }}</span>
                <span class="order-date">{{ order.createdAt | date:'mediumDate' }}</span>
              </div>
              <span class="order-status status-{{ order.status }}">
                {{ getStatusLabel(order.status) }}
              </span>
            </div>

            <div class="order-items-preview">
              @for (item of order.items; track item.productId) {
                <div class="item-preview-container">
                  <span class="item-preview">
                    {{ item.quantity }}x {{ item.productName }}
                  </span>
                  @if (item.suppliers && item.suppliers.length > 0) {
                    <div class="supplier-info">
                      <button 
                        type="button"
                        class="supplier-toggle"
                        (click)="toggleSupplierDetails(item.productId)"
                        [attr.aria-expanded]="isSupplierExpanded(item.productId)">
                        <span class="supplier-badge">
                          {{ item.suppliers.length }} proveedor{{ item.suppliers.length > 1 ? 'es' : '' }}
                        </span>
                        <span class="cost-badge">
                          Costo promedio: {{ item.averageCost | appCurrency:'1.2-2' }}
                        </span>
                        <span class="toggle-icon">{{ isSupplierExpanded(item.productId) ? 'â–¼' : 'â–¶' }}</span>
                      </button>
                      @if (isSupplierExpanded(item.productId)) {
                        <div class="supplier-details">
                          <div class="supplier-distribution">
                            <div class="distribution-header">
                              <strong>DistribuciÃ³n de Proveedores:</strong>
                            </div>
                            @for (supplier of item.suppliers; track supplier.productSupplierId) {
                              <div class="supplier-item">
                                <span class="supplier-name">{{ supplier.supplierName }}</span>
                                <span class="supplier-quantity">{{ supplier.quantity }} unidades</span>
                                <span class="supplier-cost">${{ supplier.unitCost.toFixed(2) }}/unidad</span>
                                <span class="supplier-total">Total: {{ supplier.totalCost | appCurrency:'1.2-2' }}</span>
                              </div>
                            }
                            <div class="weighted-average">
                              <strong>Costo Promedio Ponderado:</strong>
                              <span class="average-value">{{ item.averageCost | appCurrency:'1.2-2' }}</span>
                              <small class="calculation-hint">
                                ({{ getSupplierCalculationFormula(item) }} = {{ getSupplierTotalCost(item) | appCurrency:'1.2-2' }} Ã· {{ item.quantity }})
                              </small>
                            </div>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>

            <div class="order-footer">
              <span class="order-total">Total: {{ order.total | appCurrency:'1.2-2' }}</span>
              <!-- <a [routerLink]="['/orders', order.id]" class="btn-details">Ver Detalles</a> -->
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="empty-state">
        <span class="empty-icon">ðŸ“¦</span>
        <h2>No tienes Ã³rdenes todavÃ­a</h2>
        <a routerLink="/products" class="btn btn-primary">Ir a comprar</a>
      </div>
    }
  </div>
</div>
