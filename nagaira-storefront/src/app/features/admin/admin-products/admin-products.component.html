<div class="admin-products">
  <div class="page-header">
    <h1>Gestión de Productos</h1>
    <button class="btn btn-primary" routerLink="/admin/products/new">+ Nuevo Producto</button>
  </div>

  <div class="filters">
    <div class="search-box">
      <input 
        type="text" 
        placeholder="Buscar productos..." 
        [ngModel]="searchTerm()"
        (ngModelChange)="onSearchInput($event)"
        (keyup.enter)="onSearch()"
      >
      <button (click)="onSearch()" class="btn btn-secondary">Buscar</button>
    </div>
    
    <div class="filter-group">
      <label>Estado:</label>
      <select [ngModel]="isActiveFilter()" (ngModelChange)="isActiveFilter.set($event); onFilterChange()">
        <option [ngValue]="null">Todos</option>
        <option [ngValue]="true">Activos</option>
        <option [ngValue]="false">Inactivos</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Destacados:</label>
      <select [ngModel]="isFeaturedFilter()" (ngModelChange)="isFeaturedFilter.set($event); onFilterChange()">
        <option [ngValue]="null">Todos</option>
        <option [ngValue]="true">Solo destacados</option>
        <option [ngValue]="false">No destacados</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Categoria:</label>
      <select [ngModel]="categoryFilter()" (ngModelChange)="categoryFilter.set($event); onFilterChange()">
        <option [ngValue]="null">Todas</option>
        @for (category of categories(); track category.id) {
          <option [ngValue]="category.id">{{ category.name }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label>Nivel de precio:</label>
      <select [ngModel]="priceLevelFilter()" (ngModelChange)="priceLevelFilter.set($event)">
        <option [ngValue]="null">Todos</option>
        <option value="none">Sin niveles</option>
        <option value="one">Solo 1 nivel</option>
        <option value="two">Solo 2 niveles</option>
        <option value="three">Solo 3 niveles</option>
        <option value="all">Todos los niveles</option>
      </select>
    </div>

    <div class="filter-group toggle-group">
      <label>
        <input type="checkbox" [ngModel]="showPriceLevels()" (ngModelChange)="showPriceLevels.set($event)">
        Mostrar niveles de precio
      </label>
    </div>
  </div>
  <div class="results-count">
    Mostrando {{ filteredProducts().length }} de {{ products().length }} registros
  </div>

  @if (loading()) {
    <div class="loading">Cargando productos...</div>
  } @else if (filteredProducts().length === 0) {
    <div class="empty-state">
      <p>No se encontraron productos</p>
    </div>
  } @else {
    <div class="products-table">
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (product of filteredProducts(); track product.id) {
            <tr>
              <td>{{ product.sku }}</td>
              <td>
                <strong>{{ product.name }}</strong>
                <br>
                <small>{{ product.description | slice:0:50 }}...</small>
                @if (showPriceLevels()) {
                  <div class="price-levels">
                    @for (level of priceLevels(); track level.id) {
                      @if (getPriceForLevel(product, level.id); as price) {
                        <span class="price-pill" [class.inactive]="!price.isActive">
                          {{ level.name }}:
                          @if (price.isActive) {
                            {{ price.price | appCurrency }}
                          } @else {
                            Inactivo
                          }
                        </span>
                      } @else {
                        <span class="price-pill missing">
                          {{ level.name }}: Sin precio
                        </span>
                      }
                    }
                  </div>
                }
              </td>
              <td>{{ product.categoryName }}</td>
              <td>
                <span [class]="product.isActive ? 'badge active' : 'badge inactive'">
                  {{ product.isActive ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td>
                <div class="actions">
                  <button class="btn btn-sm btn-success" (click)="openMovementModal(product)" title="Agregar Stock">
                    + Stock
                  </button>
                  <button class="btn btn-sm btn-secondary" [routerLink]="['/admin/products', product.id]">
                    Editar
                  </button>
                  <button 
                    class="btn btn-sm" 
                    [class.btn-success]="!product.isActive"
                    [class.btn-warning]="product.isActive"
                    (click)="toggleProductStatus(product)"
                  >
                    {{ product.isActive ? 'Desactivar' : 'Activar' }}
                  </button>
                  <button class="btn btn-sm btn-danger" (click)="deleteProduct(product.id)">
                    Eliminar
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    @if (totalPages() > 1) {
      <div class="pagination">
        <button 
          [disabled]="pageNumber() === 1"
          (click)="goToPage(pageNumber() - 1)"
        >
          Anterior
        </button>
        <span>Página {{ pageNumber() }} de {{ totalPages() }}</span>
        <button 
          [disabled]="pageNumber() === totalPages()"
          (click)="goToPage(pageNumber() + 1)"
        >
          Siguiente
        </button>
      </div>
    }
  }
</div>

@if (showMovementModal()) {
  <div class="modal-overlay" (click)="closeMovementModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Agregar Stock - {{ selectedProduct()?.name }}</h2>
        <button class="modal-close" (click)="closeMovementModal()">×</button>
      </div>
      
      <form (ngSubmit)="createMovement()" class="movement-form">
        <div class="form-group">
          <label>Tipo de Movimiento *</label>
          <select [(ngModel)]="movementForm.movementType" name="movementType" required>
            @for (type of movementTypes(); track type.value) {
              <option [value]="type.value">{{ type.label }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>Cantidad *</label>
          <input 
            type="number" 
            [(ngModel)]="movementForm.quantity" 
            name="quantity" 
            min="1"
            required>
        </div>

        <div class="form-group">
          <label>Número de Referencia</label>
          <input 
            type="text" 
            [(ngModel)]="movementForm.referenceNumber" 
            name="referenceNumber"
            placeholder="Ej: FACT-001, OC-123">
        </div>

        <div class="form-group">
          <label>Costo por Unidad</label>
          <input 
            type="number" 
            [(ngModel)]="movementForm.costPerUnit" 
            name="costPerUnit"
            step="0.01"
            min="0"
            placeholder="0.00">
        </div>

        <div class="form-group">
          <label>Notas</label>
          <textarea 
            [(ngModel)]="movementForm.notes" 
            name="notes"
            rows="3"
            placeholder="Observaciones adicionales..."></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeMovementModal()" [disabled]="saving()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="saving()">
            {{ saving() ? 'Guardando...' : 'Registrar Ingreso' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

